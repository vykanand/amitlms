<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <link rel="icon" type="image/png" href="lms.png" />
    <script src="js/loading-overlay.js"></script>
    <script src="js/db-handshake.js"></script>
    <script src="js/tests.js"></script>
    <style>
      :root {
        --bg: #0f172a;
        --card: #0b1220;
        --accent1: #7c3aed;
        --accent2: #06b6d4;
        --muted: #94a3b8;
        --glass: rgba(255, 255, 255, 0.04);
        --soft: rgba(255, 255, 255, 0.03);
      }

      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap");

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: linear-gradient(180deg, #071021 0%, #081226 60%);
        color: #e6eef8;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        padding: 1.25rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.25rem;
      }

      .topbar {
        display: flex;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(
          90deg,
          rgba(124, 58, 237, 0.12),
          rgba(6, 182, 212, 0.06)
        );
        padding: 1rem;
        border-radius: 18px;
        box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(6px);
      }

      .brand {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      .brand img {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        object-fit: cover;
      }
      .brand h1 {
        font-size: 1.25rem;
        margin: 0;
        letter-spacing: 0.2px;
      }
      .brand p {
        margin: 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .profile-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.4rem 0.6rem;
        border-radius: 14px;
        background: var(--glass);
      }
      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent1), var(--accent2));
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        color: white;
      }
      .profile-name {
        font-weight: 700;
      }
      .profile-sub {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .logout-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.06);
        color: var(--accent2);
        padding: 0.5rem 0.9rem;
        border-radius: 12px;
        cursor: pointer;
      }

      /* Main grid */
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        align-items: start;
      }

      @media (max-width: 900px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border-radius: 18px;
        padding: 1rem;
        box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.03);
      }

      .section-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .section-title h2 {
        margin: 0;
        font-size: 1.05rem;
      }
      .section-sub {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .courses-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 1rem;
      }
      .course-card {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        padding: 0.75rem;
        border-radius: 14px;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.02),
          rgba(255, 255, 255, 0.01)
        );
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      .course-card img {
        width: 72px;
        height: 72px;
        border-radius: 12px;
        object-fit: cover;
        border: 1px solid rgba(255, 255, 255, 0.04);
      }
      .course-info h3 {
        margin: 0;
        font-size: 1rem;
      }
      .course-info p {
        margin: 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .meta-row {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
      }
      .pill {
        padding: 0.25rem 0.6rem;
        border-radius: 999px;
        background: var(--soft);
        color: var(--muted);
        font-size: 0.85rem;
      }

      .test-status {
        padding: 0.45rem 0.65rem;
        border-radius: 12px;
        font-weight: 600;
      }
      .test-status.completed {
        background: rgba(34, 197, 94, 0.12);
        color: #bbf7d0;
      }
      .test-status.in-progress {
        background: rgba(250, 204, 21, 0.08);
        color: #fde68a;
      }

      .actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .btn {
        border-radius: 12px;
        padding: 0.5rem 0.9rem;
        border: none;
        cursor: pointer;
      }
      .btn-primary {
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        color: white;
      }
      .btn-ghost {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.04);
        color: var(--accent2);
      }

      .progress-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .progress-item {
        border-radius: 12px;
        padding: 0.75rem;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.01),
          rgba(255, 255, 255, 0.005)
        );
        border: 1px solid rgba(255, 255, 255, 0.02);
      }
      .progress-bar {
        background: rgba(255, 255, 255, 0.03);
        height: 8px;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent1), var(--accent2));
        width: 0;
      }

      .right-col .card + .card {
        margin-top: 1rem;
      }

      /* modal */
      .modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 1200;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.6),
          rgba(2, 6, 23, 0.8)
        );
      }
      .modal-content {
        max-width: 900px;
        width: 95%;
        border-radius: 14px;
        overflow: hidden;
      }
      .modal-content img {
        width: 100%;
        height: auto;
        display: block;
      }
      .close {
        position: absolute;
        right: 18px;
        top: 18px;
        background: rgba(0, 0, 0, 0.4);
        padding: 6px 10px;
        border-radius: 10px;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <img src="lms.png" alt="logo" />
          <div>
            <h1>TO THE POINT</h1>
            <p class="section-sub">Student Dashboard</p>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem">
          <div class="profile-card">
            <div class="avatar">A</div>
            <div>
              <div class="profile-name" id="profile-name">Student</div>
              <div class="profile-sub">
                Logged in as <span id="user-phone"></span>
              </div>
            </div>
          </div>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="main-grid">
        <div>
          <div class="card">
            <div class="section-title">
              <h2>My Purchased Courses</h2>
              <div class="section-sub">Access your course materials</div>
            </div>
            <div id="my-courses-container" class="courses-grid">
              <!-- Purchased courses will be loaded here -->
            </div>
          </div>

          <div class="card" style="margin-top: 1rem">
            <div class="section-title">
              <h2>My Purchased Tests</h2>
              <div class="section-sub">Start, resume or view reports</div>
            </div>
            <div id="my-tests-container" class="courses-grid">
              <!-- Purchased tests will be loaded here -->
            </div>
            <!-- test-progress will be injected by script after this container -->
          </div>

          <div class="card" style="margin-top: 1rem">
            <div class="section-title">
              <h2>Purchase More</h2>
              <div class="section-sub">Courses & Test Series</div>
            </div>
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
              "
            >
              <div>
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.95rem">
                  Courses
                </h3>
                <div id="all-courses-container" class="courses-grid"></div>
              </div>
              <div>
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.95rem">Tests</h3>
                <div id="all-tests-container" class="courses-grid"></div>
              </div>
            </div>
          </div>
        </div>

        <aside class="right-col">
          <div class="card">
            <div class="section-title">
              <h2>Cart</h2>
              <div class="section-sub">Items you plan to purchase</div>
            </div>
            <div id="cart-container" class="progress-list">
              <!-- Cart courses will be loaded here -->
            </div>
          </div>

          <div class="card">
            <div class="section-title">
              <h2>Purchase History</h2>
              <div class="section-sub">Your past orders</div>
            </div>
            <div id="purchase-history-container" class="progress-list">
              <!-- Purchase history will be loaded here -->
            </div>
          </div>
        </aside>
      </div>

      <!-- Modal for image viewing -->
      <div id="image-modal" class="modal">
        <div class="close" onclick="closeModal()">&times;</div>
        <div class="modal-content card">
          <img id="modal-image" src="" alt="Payment Screenshot" />
        </div>
      </div>
    </div>

    <script>
      // Check if user is logged in
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        globalThis.location.href = "studentlogin.html";
      }

      // Display user phone
      document.getElementById("user-phone").textContent = user.phone;

      // Ensure user has tests array
      if (!user.tests) {
        user.tests = [];
        localStorage.setItem("user", JSON.stringify(user));
      }

      // Load user's purchased courses (from approved purchases)
      async function loadPurchasedCourses() {
        const container = document.getElementById("my-courses-container");

        try {
          const response = await addSessionToRequest(
            "/api/user/courses?phone=" + encodeURIComponent(user.phone)
          );
          const userCourses = await response.json();

          if (!userCourses || userCourses.length === 0) {
            container.innerHTML =
              '<p class="no-courses">No courses purchased yet.</p>';
            return;
          }

          container.innerHTML = userCourses
            .map(
              (course) => `
          <a href="course.html?id=${
            course.id
          }" style="text-decoration: none; color: inherit;">
            <div class="course-card">
              <img src="${
                course.coursepic || "https://via.placeholder.com/100"
              }" alt="${course.coursename}" />
              <div class="course-info">
                <h3>${course.coursename}</h3>
                <p>${course.coursedesc}</p>
                <p>Duration: ${course.duration}</p>
                <p>Price: ₹${course.price}</p>
              </div>
            </div>
          </a>
        `
            )
            .join("");
        } catch (error) {
          console.error("Error loading purchased courses:", error);
          container.innerHTML =
            '<p class="no-courses">Error loading purchased courses.</p>';
        }
      }

      // Calculate test evaluation (MCQ + descriptive scores)
      function calculateTestEvaluation(questions, sessionData) {
        if (!questions)
          return { correct: 0, total: 0, score: 0, descriptiveCount: 0 };

        let correctMCQ = 0;
        let totalMCQ = 0;
        let descriptiveCount = 0;
        let totalScore = 0;

        questions.forEach((question, index) => {
          const userAnswer = sessionData.answers[index];

          if (question.type === "mcq") {
            totalMCQ++;
            // Check if answer is correct
            if (
              userAnswer &&
              question.correct &&
              userAnswer.toLowerCase() === question.correct.toLowerCase()
            ) {
              correctMCQ++;
              totalScore += 1; // 1 point per correct MCQ
            }
          } else if (question.type === "desc") {
            descriptiveCount++;
            // For descriptive questions, check if admin has graded it
            if (
              sessionData.descriptiveScores &&
              sessionData.descriptiveScores[index] !== undefined
            ) {
              totalScore += sessionData.descriptiveScores[index];
            }
            // If not graded yet, don't add to score but count as attempted
          }
        });

        return {
          correct: correctMCQ,
          total: totalMCQ,
          score: totalScore,
          descriptiveCount: descriptiveCount,
          totalPossibleScore: totalMCQ + descriptiveCount, // Assuming descriptive questions are worth 1 point each
        };
      }

      // Load user's purchased tests (from approved purchases)
      async function loadPurchasedTests() {
        const container = document.getElementById("my-tests-container");
        const progressDiv = document.createElement("div");
        progressDiv.id = "test-progress";
        progressDiv.className = "test-progress";
        container.parentNode.insertBefore(progressDiv, container.nextSibling);

        try {
          const response = await addSessionToRequest(
            "/api/user/tests?phone=" + encodeURIComponent(user.phone)
          );
          const userTests = await response.json();

          if (!userTests || userTests.length === 0) {
            container.innerHTML =
              '<p class="no-courses">No tests purchased yet.</p>';
            return;
          }

          // Fetch test session
          const sessionResponse = await fetch(
            `/api/user/testsession?phone=${user.phone}`
          );
          let session = {};
          if (sessionResponse.ok) {
            session = await sessionResponse.json();
            console.log("Fetched session data:", session);
          } else {
            console.error(
              "Failed to fetch session data:",
              sessionResponse.status
            );
            session = {};
          }

          container.innerHTML = userTests
            .map((test) => {
              // Check if test is completed or in progress
              const sessionData = session[test.id];
              let progressInfo = "";
              let buttonText = "Start Test";
              let buttonClass = "btn-primary";
              let evaluation = null;
              let detailedInfo = "";

              if (sessionData) {
                const totalQuestions = test.questions?.length || 0;
                const answeredQuestions = Object.keys(
                  sessionData.answers || {}
                ).length;
                const isCompleted =
                  sessionData.completed || answeredQuestions >= totalQuestions;

                if (isCompleted) {
                  evaluation = calculateTestEvaluation(
                    test.questions,
                    sessionData
                  );
                  const scorePercentage =
                    evaluation.totalPossibleScore > 0
                      ? Math.round(
                          (evaluation.score / evaluation.totalPossibleScore) *
                            100
                        )
                      : 0;

                  progressInfo = `<div class="test-status completed">
                <i class="fas fa-check-circle"></i>
                <span>Completed: ${scorePercentage}% (${evaluation.score}/${evaluation.totalPossibleScore})</span>
              </div>`;

                  buttonText = "View Report";
                  buttonClass = "btn-success";
                  detailedInfo = `
                <div class="test-details">
                  <div class="detail-item">
                    <span class="detail-label">MCQ Score:</span>
                    <span class="detail-value">${evaluation.correct}/${evaluation.total} correct</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Descriptive:</span>
                    <span class="detail-value">${evaluation.descriptiveCount} questions</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Total Score:</span>
                    <span class="detail-value">${evaluation.score}/${evaluation.totalPossibleScore}</span>
                  </div>
                </div>
              `;
                } else {
                  const percentage =
                    totalQuestions > 0
                      ? Math.round((answeredQuestions / totalQuestions) * 100)
                      : 0;
                  progressInfo = `<div class="test-status in-progress">
                <i class="fas fa-clock"></i>
                <span>In Progress: ${answeredQuestions}/${totalQuestions} questions (${percentage}%)</span>
              </div>`;

                  buttonText = "Resume Test";
                  buttonClass = "btn-warning";
                  detailedInfo = `
                <div class="test-details">
                  <div class="detail-item">
                    <span class="detail-label">Current Question:</span>
                    <span class="detail-value">${
                      (sessionData.currentIndex || 0) + 1
                    } of ${totalQuestions}</span>
                  </div>
                  <div class="detail-item">
                    <span class="detail-label">Time Spent:</span>
                    <span class="detail-value">Auto-saved</span>
                  </div>
                </div>
              `;
                }
              }

              return `
          <div class="course-card test-card">
            ${
              test.image
                ? `<img src="${test.image}" alt="${test.title}" onerror="this.style.display='none'" />`
                : ""
            }
            <div class="course-info">
              <h3>${test.title}</h3>
              <p>${test.description || ""}</p>
              <div class="test-meta">
                <span><i class="fas fa-question-circle"></i> ${
                  test.questions?.length || 0
                } questions</span>
                <span><i class="fas fa-clock"></i> ${
                  (test.questions?.length || 0) * 5
                } mins</span>
                <span><i class="fas fa-rupee-sign"></i> ${
                  test.price ? test.price : "Free"
                }</span>
              </div>
              ${progressInfo}
              ${detailedInfo}
              <button onclick="window.location.href='test-runner.html?testId=${
                test.id
              }'" class="btn ${buttonClass}">
                <i class="fas fa-${
                  buttonText === "View Report"
                    ? "chart-bar"
                    : buttonText === "Resume Test"
                    ? "play"
                    : "play"
                }"></i>
                ${buttonText}
              </button>
            </div>
          </div>
        `;
            })
            .join("");

          // Show overall progress section
          const progressDiv = document.getElementById("test-progress");
          progressDiv.innerHTML =
            '<h4><i class="fas fa-chart-line"></i> Test Progress Summary</h4>';

          console.log("Session data:", session);
          console.log("User tests:", userTests);

          const completedTests = [];
          const inProgressTests = [];

          if (Object.keys(session).length === 0) {
            progressDiv.innerHTML +=
              '<div class="no-progress"><i class="fas fa-info-circle"></i><p>No test sessions found. Start taking a test to see progress here.</p></div>';
          } else {
            Object.keys(session).forEach((testId) => {
              const s = session[testId];
              const test = userTests.find((t) => String(t.id) === testId);
              const title = test ? test.title : `Test ${testId}`;
              const totalQuestions = test ? test.questions?.length || 0 : 0;
              const answeredQuestions = Object.keys(s.answers || {}).length;
              const isCompleted =
                s.completed || answeredQuestions >= totalQuestions;

              console.log(
                `Processing test ${testId}:`,
                s,
                `answered: ${answeredQuestions}, total: ${totalQuestions}, completed: ${isCompleted}`
              );

              if (isCompleted) {
                const evaluation = calculateTestEvaluation(
                  test ? test.questions : [],
                  s
                );
                const scorePercentage =
                  evaluation.totalPossibleScore > 0
                    ? Math.round(
                        (evaluation.score / evaluation.totalPossibleScore) * 100
                      )
                    : 0;

                completedTests.push(`
                <div class="progress-item completed">
                  <div class="progress-header">
                    <h5>${title}</h5>
                    <span class="score-badge">${scorePercentage}%</span>
                  </div>
                  <div class="progress-details">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${scorePercentage}%"></div>
                    </div>
                    <div class="progress-stats">
                      <span>MCQ: ${evaluation.correct}/${evaluation.total}</span>
                      <span>Score: ${evaluation.score}/${evaluation.totalPossibleScore}</span>
                    </div>
                  </div>
                  <a href="test-runner.html?testId=${testId}" class="view-report-btn">
                    <i class="fas fa-chart-bar"></i> View Detailed Report
                  </a>
                </div>
              `);
              } else {
                const percentage =
                  totalQuestions > 0
                    ? Math.round((answeredQuestions / totalQuestions) * 100)
                    : 0;
                inProgressTests.push(`
                <div class="progress-item in-progress">
                  <div class="progress-header">
                    <h5>${title}</h5>
                    <span class="progress-badge">${percentage}%</span>
                  </div>
                  <div class="progress-details">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-stats">
                      <span>${answeredQuestions}/${totalQuestions} questions</span>
                      <span>Question ${
                        s.currentIndex + 1
                      } of ${totalQuestions}</span>
                    </div>
                  </div>
                  <a href="test-runner.html?testId=${testId}" class="resume-btn">
                    <i class="fas fa-play"></i> Resume Test
                  </a>
                </div>
              `);
              }
            });

            if (completedTests.length > 0) {
              progressDiv.innerHTML +=
                '<h5><i class="fas fa-check-circle"></i> Completed Tests</h5>' +
                completedTests.join("");
            }
            if (inProgressTests.length > 0) {
              progressDiv.innerHTML +=
                '<h5><i class="fas fa-clock"></i> In Progress</h5>' +
                inProgressTests.join("");
            }
            if (completedTests.length === 0 && inProgressTests.length === 0) {
              progressDiv.innerHTML +=
                '<div class="no-progress"><i class="fas fa-info-circle"></i><p>No active test sessions found.</p></div>';
            }
          }
        } catch (error) {
          console.error("Error loading purchased tests:", error);
          container.innerHTML =
            '<p class="no-courses">Error loading purchased tests.</p>';
        }
      }

      function logout() {
        localStorage.removeItem("user");
        globalThis.location.href = "studentlogin.html";
      }

      // Load cart
      async function loadCart() {
        const container = document.getElementById("cart-container");
        const cart = JSON.parse(localStorage.getItem("cart") || "[]");

        if (cart.length === 0) {
          container.innerHTML = '<p class="no-courses">No items in cart.</p>';
          return;
        }

        let coursesHtml = "";
        let testsHtml = "";
        let total = 0;

        try {
          // Load courses from cart
          const courseItems = cart.filter((item) => item.type === "course");
          if (courseItems.length > 0) {
            const response = await addSessionToRequest("/api/courses");
            const allCourses = await response.json();
            const cartCourses = allCourses.filter((course) => {
              const inCart = courseItems.some(
                (item) => item.id === course.id.toString()
              );
              const notPurchased = !user.courses.includes(course.id.toString());
              return inCart && notPurchased;
            });

            if (cartCourses.length > 0) {
              coursesHtml = cartCourses
                .map(
                  (course) => `
              <div class="course-card">
                <img src="${
                  course.coursepic || "https://via.placeholder.com/100"
                }" alt="${course.coursename}" />
                <div class="course-info">
                  <h3>${course.coursename}</h3>
                  <p>${course.coursedesc}</p>
                  <p>Duration: ${course.duration}</p>
                  <p>Price: ₹${course.price}</p>
                </div>
              </div>
            `
                )
                .join("");
              total += cartCourses.reduce(
                (sum, course) => sum + Number.parseInt(course.price, 10),
                0
              );
            }
          }

          // Load tests from cart
          const testItems = cart.filter((item) => item.type === "test");
          if (testItems.length > 0) {
            const allSeries = await TestsApi.getAllSeries();
            const cartTests = allSeries.filter((test) =>
              testItems.some((item) => item.id === test.id.toString())
            );

            if (cartTests.length > 0) {
              testsHtml = cartTests
                .map(
                  (test) => `
              <div class="course-card">
                ${
                  test.image
                    ? `<img src="${test.image}" alt="${test.title}" onerror="this.style.display='none'" />`
                    : ""
                }
                <div class="course-info">
                  <h3>${test.title}</h3>
                  <p>${test.description || ""}</p>
                  <p>Questions: ${test.questions?.length || 0}</p>
                  <p>Time: ${(test.questions?.length || 0) * 5} mins</p>
                  <p>Price: ${test.price ? `₹${test.price}` : "Free"}</p>
                </div>
              </div>
            `
                )
                .join("");
              total += cartTests.reduce(
                (sum, test) => sum + (Number.parseInt(test.price, 10) || 0),
                0
              );
            }
          }

          if (coursesHtml || testsHtml) {
            container.innerHTML = `
            ${coursesHtml}
            ${testsHtml}
            <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 8px; text-align: right;">
              <h3>Total: ₹${total}</h3>
              <button onclick="payForCart(${total})" style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; font-size: 1rem; cursor: pointer;">Pay Now for All</button>
            </div>
          `;
          } else {
            container.innerHTML = '<p class="no-courses">No items in cart.</p>';
          }
        } catch (error) {
          console.error("Error loading cart:", error);
          container.innerHTML = '<p class="no-courses">Error loading cart.</p>';
        }
      }

      function payForCart(total) {
        const orderId = user.phone + "-" + Date.now();
        globalThis.location.href = `pay.html?amount=${total}&orderId=${orderId}`;
      }

      // Load all courses
      async function loadAllCourses() {
        const container = document.getElementById("all-courses-container");

        try {
          const response = await addSessionToRequest("/api/courses");
          const allCourses = await response.json();
          const availableCourses = allCourses.filter(
            (course) => !user.courses.includes(course.id.toString())
          );

          if (availableCourses.length === 0) {
            container.innerHTML =
              '<p class="no-courses">No courses available.</p>';
            return;
          }

          container.innerHTML = availableCourses
            .map(
              (course) => `
          <div class="course-card">
            <img src="${
              course.coursepic || "https://via.placeholder.com/100"
            }" alt="${course.coursename}" />
            <div class="course-info">
              <h3>${course.coursename}</h3>
              <p>${course.coursedesc}</p>
              <p>Duration: ${course.duration}</p>
              <p>Price: ₹${course.price}</p>
              <button onclick="addToCart(${
                course.id
              })" style="background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Add to Cart</button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("Error loading all courses:", error);
          container.innerHTML =
            '<p class="no-courses">Error loading courses.</p>';
        }
      }

      // Load all tests
      async function loadAllTests() {
        const container = document.getElementById("all-tests-container");

        try {
          const allSeries = await TestsApi.getAllSeries();
          const availableTests = allSeries.filter(
            (test) => !user.tests || !user.tests.includes(test.id)
          );

          if (availableTests.length === 0) {
            container.innerHTML =
              '<p class="no-courses">No tests available.</p>';
            return;
          }

          container.innerHTML = availableTests
            .map(
              (test) => `
          <div class="course-card">
            ${
              test.image
                ? `<img src="${test.image}" alt="${test.title}" onerror="this.style.display='none'" />`
                : ""
            }
            <div class="course-info">
              <h3>${test.title}</h3>
              <p>${test.description || ""}</p>
              <p>Questions: ${test.questions?.length || 0}</p>
              <p>Time: ${(test.questions?.length || 0) * 5} mins</p>
              <p>Price: ${test.price ? `₹${test.price}` : "Free"}</p>
              <button onclick="addTestToCart('${
                test.id
              }')" style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Add to Cart</button>
            </div>
          </div>
        `
            )
            .join("");
        } catch (error) {
          console.error("Error loading all tests:", error);
          container.innerHTML =
            '<p class="no-courses">Error loading tests.</p>';
        }
      }

      function addToCart(courseId) {
        courseId = courseId.toString();
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        if (
          !cart.some((item) => item.id === courseId && item.type === "course")
        ) {
          cart.push({ id: courseId, type: "course" });
          localStorage.setItem("cart", JSON.stringify(cart));
          location.reload();
        }
      }

      function addTestToCart(testId) {
        testId = testId.toString();
        let cart = JSON.parse(localStorage.getItem("cart") || "[]");
        if (!cart.some((item) => item.id === testId && item.type === "test")) {
          cart.push({ id: testId, type: "test" });
          localStorage.setItem("cart", JSON.stringify(cart));
          location.reload();
        }
      }

      // Load purchase history
      async function loadPurchaseHistory() {
        const container = document.getElementById("purchase-history-container");

        try {
          const response = await fetch(
            `/api/user/purchases?phone=${user.phone}`
          );
          const purchases = await response.json();

          if (purchases.length === 0) {
            container.innerHTML =
              '<p class="no-courses">No purchase history.</p>';
            return;
          }

          const purchaseHtml = purchases
            .map(
              (purchase) => `
          <div class="course-card">
            <div class="course-info">
              <h3>Order ID: ${purchase.orderId}</h3>
              <p>Items: ${purchase.items
                .map((item) => `${item.type} ${item.id}`)
                .join(", ")}</p>
              <p>Amount: ₹${purchase.amount}</p>
              <p>Status: <span style="color: ${
                purchase.status === "approved"
                  ? "green"
                  : purchase.status === "rejected"
                  ? "red"
                  : "orange"
              };">${purchase.status}</span></p>
              <p>Date: ${new Date(purchase.createdAt).toLocaleDateString()}</p>
              ${
                purchase.screenshot
                  ? `<p><img src="${purchase.screenshot}" alt="Payment Screenshot" style="max-width: 200px; cursor: pointer;" onclick="openModal('${purchase.screenshot}')"></p>`
                  : ""
              }
            </div>
          </div>
        `
            )
            .join("");

          container.innerHTML = purchaseHtml;
        } catch (error) {
          console.error("Error loading purchase history:", error);
          container.innerHTML =
            '<p class="no-courses">Error loading purchase history.</p>';
        }
      }

      function openModal(imageSrc) {
        document.getElementById("modal-image").src = imageSrc;
        document.getElementById("image-modal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("image-modal").style.display = "none";
      }

      // Initialize database handshake and load content when ready
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          // Start database handshake
          await initializeDatabaseHandshake({
            retryAttempts: 3,
            retryDelay: 3000,
            overlayOptions: {
              title: "Loading Dashboard...",
              message: "Please wait...",
              size: "medium",
              theme: "default",
            },
            onReady: () => {
              loadPurchasedCourses();
              loadPurchasedTests();
              loadPurchaseHistory();
              loadCart();
              loadAllCourses();
              loadAllTests();
            },
            onError: (error) => {
              console.error("Database handshake failed:", error);
              document.getElementById("courses-container").innerHTML =
                '<p class="no-courses">Unable to load dashboard. Please refresh the page to try again.</p>';
            },
          });
        } catch (error) {
          console.error("Failed to initialize database handshake:", error);
          // Fallback to load without handshake
          loadPurchasedCourses();
          loadPurchasedTests();
          loadPurchaseHistory();
          loadCart();
          loadAllCourses();
          loadAllTests();
        }
      });
    </script>
  </body>
</html>
