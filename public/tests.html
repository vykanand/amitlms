<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Series</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f5f7fa; color:#2d3748; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .btn-primary { background: linear-gradient(90deg, #2c5aa0, #b83280); color:#fff; padding:0.5rem 1rem; border-radius:8px; font-weight:600; display:inline-block; }
    .card { background:#fff; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header class="bg-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold">Test Series</h1>
      <a class="btn-primary" href="index.html">Home</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4">
    <div id="tests-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>

  <script src="js/loading-overlay.js"></script>
  <script src="js/db-handshake.js"></script>
  <script src="js/tests.js"></script>
  <script>
    async function loadTests(){
      try{
        const series = await TestsApi.getAllSeries();
        const container = document.getElementById('tests-container');
        if(!series || series.length===0){ container.innerHTML = '<p class="text-center text-gray-600">No test series available.</p>'; return; }
        container.innerHTML = series.map(s=>`
          <div class="card p-5 flex flex-col">
            ${ (s.image || s.imageUrl) ? `<img src="${s.image || s.imageUrl}" alt="${s.title||'Test'}" class="w-full h-44 object-cover rounded-lg mb-3" onerror="this.style.display='none'"/>` : ''}
            <h3 class="text-xl font-semibold mb-2">${s.title}</h3>
            <p class="text-gray-600 mb-3">${s.description||''}</p>
            <div class="flex justify-between items-center mb-3">
              <span class="text-sm text-gray-500">Questions: ${s.questions?.length||0}</span>
              <span class="text-lg font-bold text-blue-600">${s.price?`₹${s.price}`:'Free'}</span>
            </div>
            <div class="mb-3">
              <span class="text-sm text-gray-500">Time: ${s.questions?.length||0} × 5 mins = ${(s.questions?.length||0)*5} mins</span>
            </div>
            <button class="btn-primary text-center w-full" onclick="buyTest('${s.id}')">Buy / Start</button>
          </div>
        `).join('');
      }catch(e){
        console.error('Failed to load tests', e);
        document.getElementById('tests-container').innerHTML = '<p class="text-center text-red-600">Failed to load tests.</p>';
      }
    }

    function buyTest(testId) {
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user) {
        window.location.href = 'studentlogin.html';
        return;
      }
      let cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (!cart.some(item => item.id === testId && item.type === 'test')) {
        cart.push({ id: testId, type: 'test' });
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      window.location.href = 'studentdashboard.html';
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await initializeDatabaseHandshake({
        retryAttempts: 2, retryDelay: 2000,
        overlayOptions: { title: 'Loading Tests...', message: 'Please wait...', size: 'small', theme: 'default' },
        onReady: ()=>loadTests(), onError: ()=>loadTests()
      });
    });
  </script>
</body>
</html>